<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>arapaima.uk </title>
    <link>http://arapaima.uk/tags/ssdt/</link>
    <language>en-us</language>
    <author>Gavin Campbell</author>
    <rights>(C) 2018</rights>
    <updated>2018-03-17 00:00:00 &#43;0000 UTC</updated>

    
      
        <item>
          <title>Building an SSDT project with YAML build in VSTS</title>
          <link>http://arapaima.uk/post/2018-03-17-building-ssdt-project-vsts-yaml/</link>
          <pubDate>Sat, 17 Mar 2018 00:00:00 UTC</pubDate>
          <author>Gavin Campbell</author>
          <guid>http://arapaima.uk/post/2018-03-17-building-ssdt-project-vsts-yaml/</guid>
          <description>

&lt;p&gt;It may have been a while coming, at least compared to &lt;a href=&#34;https://jenkins.io/solutions/pipeline/&#34;&gt;Jenkins Pipeline&lt;/a&gt;, &lt;a href=&#34;https://travis-ci.org/&#34;&gt;Travis-CI&lt;/a&gt;, and friends, but VSTS now offers the facility to specify your build pipeline as YAML, meaning it can be version controlled with your application code. YAML Release Management Pipelines are &amp;ldquo;on the way&amp;rdquo;, but not yet publically available.&lt;/p&gt;

&lt;blockquote class=&#34;twitter-tweet&#34;&gt;&lt;p lang=&#34;en&#34; dir=&#34;ltr&#34;&gt;The YAML Build is. The release is not yet.  &lt;a href=&#34;https://t.co/FCHfdfMHd7&#34;&gt;https://t.co/FCHfdfMHd7&lt;/a&gt;&lt;/p&gt;&amp;mdash; Donovan Brown (@DonovanBrown) &lt;a href=&#34;https://twitter.com/DonovanBrown/status/971796151862222848?ref_src=twsrc%5Etfw&#34;&gt;March 8, 2018&lt;/a&gt;&lt;/blockquote&gt;
&lt;script async src=&#34;https://platform.twitter.com/widgets.js&#34; charset=&#34;utf-8&#34;&gt;&lt;/script&gt;


&lt;p&gt;YAML Build Definitions are currently in public preview, so you&amp;rsquo;ll need to ensure you have the &lt;a href=&#34;https://docs.microsoft.com/en-us/vsts/collaborate/preview-features&#34;&gt;feature enabled for your account&lt;/a&gt;.&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:1&#34;&gt;&lt;a rel=&#34;footnote&#34; href=&#34;#fn:1&#34;&gt;1&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;

&lt;h2 id=&#34;the-sample-project&#34;&gt;The Sample Project&lt;/h2&gt;

&lt;p&gt;We don&amp;rsquo;t even need to download anything to get going with this, we can just use the WideWorldImporters Sample Database, which is buried in the &lt;a href=&#34;https://github.com/Microsoft/sql-server-samples&#34;&gt;SQL Server Samples repo on GitHub&lt;/a&gt;, as VSTS supports building GitHub hosted projects. If you&amp;rsquo;re following along, you&amp;rsquo;ll need to &lt;a href=&#34;https://help.github.com/articles/fork-a-repo/&#34;&gt;create your own fork&lt;/a&gt; of the official &lt;a href=&#34;https://github.com/Microsoft/sql-server-samples&#34;&gt;Microsoft/sql-server-samples&lt;/a&gt; repo, as we&amp;rsquo;ll be adding the YAML build definition to the root of our repo (yes, you need to have a &lt;a href=&#34;https://github.com/join&#34;&gt;Github Account&lt;/a&gt; for this to work). According to the &lt;a href=&#34;https://docs.microsoft.com/en-us/vsts/build-release/actions/build-yaml&#34;&gt;docs&lt;/a&gt;, the only sources currently supported for YAML Build Definitions are Git (hosted in VSTS) and GitHub, so if your code is hosted elsewhere you&amp;rsquo;ll have to wait a while longer.&lt;/p&gt;

&lt;h3 id=&#34;creating-a-dummy-build-definition&#34;&gt;Creating a dummy build definition&lt;/h3&gt;

&lt;p&gt;Just to make sure everything is working, it&amp;rsquo;s not a bad idea to go ahead and create a trivial build definition now. By convention, this file is called &lt;code&gt;.vsts-ci.yml&lt;/code&gt; and is placed at the root of the repo. You can create this directly from the GitHub UI with the &amp;ldquo;Create New File&amp;rdquo; button. &lt;a href=&#34;https://github.com/arapaima-uk/sql-server-samples/blob/fa28d3f8803991a20884722e23fe01be6f170ca4/.vsts-ci.yml&#34;&gt;Mine&lt;/a&gt; just has a single step, which is rather unimaginative:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;steps&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;-&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;script&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;echo&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;hello&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;world&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&#34;making-sure-vsts-can-talk-to-github&#34;&gt;Making sure VSTS can talk to GitHub&lt;/h2&gt;

&lt;p&gt;The easiest way to do this, in my view at least, is to create a &lt;a href=&#34;https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/&#34;&gt;Personal Access Token&lt;/a&gt; we can use so that VSTS can authenticate to GitHub. The &lt;code&gt;public_repo&lt;/code&gt; scope will be adequate for everything we need to do here.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://s3-eu-west-1.amazonaws.com/aksidjenakfjg/github-vsts-yaml/create-access-token-public-repo.png&#34; alt=&#34;Creating a personal access token&#34; /&gt;&lt;/p&gt;

&lt;p&gt;You will need to copy the value of the token from GitHub as soon as you create it, it won&amp;rsquo;t be accessible again.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://s3-eu-west-1.amazonaws.com/aksidjenakfjg/github-vsts-yaml/copy-personal-access-token.png&#34; alt=&#34;Copying the access token&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;creating-the-project-in-vsts&#34;&gt;Creating the Project in VSTS&lt;/h2&gt;

&lt;p&gt;Having selected the &amp;ldquo;New Project&amp;rdquo; button, we have a couple of forms to fill in. The first is just to give our VSTS project a name, the rest of the fields can be left at their defaults.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://s3-eu-west-1.amazonaws.com/aksidjenakfjg/github-vsts-yaml/vst-new-project.png&#34; alt=&#34;Creating a new project in VSTS&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Next, we specify that we are building code from an external repo, and select &amp;ldquo;Setup Build&amp;rdquo;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://s3-eu-west-1.amazonaws.com/aksidjenakfjg/github-vsts-yaml/setup-build.png&#34; alt=&#34;Building code from an external repo&#34; /&gt;&lt;/p&gt;

&lt;p&gt;In the next screen, we specify that we are building a project from GitHub, and paste in the access token we created earlier.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://s3-eu-west-1.amazonaws.com/aksidjenakfjg/github-vsts-yaml/entering-the-access-token.png&#34; alt=&#34;entering the personal access token&#34; /&gt;.&lt;/p&gt;

&lt;p&gt;Finally, we are presented with a list of all the repos our account has access to. We need to find our clone of &lt;code&gt;sql-server-samples&lt;/code&gt; in this list and select it.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://s3-eu-west-1.amazonaws.com/aksidjenakfjg/github-vsts-yaml/select-repo.png&#34; alt=&#34;selecting the repo&#34; /&gt;&lt;/p&gt;

&lt;p&gt;We&amp;rsquo;re presented with a list of build process templates, the one we want is &amp;ldquo;YAML&amp;rdquo;&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://s3-eu-west-1.amazonaws.com/aksidjenakfjg/github-vsts-yaml/select-yaml-build.png&#34; alt=&#34;selecting YAML build&#34; /&gt;.&lt;/p&gt;

&lt;p&gt;All that&amp;rsquo;s left to do is specify the path to our YAML build definition, in this case &lt;code&gt;.vsts-ci-yml&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://s3-eu-west-1.amazonaws.com/aksidjenakfjg/github-vsts-yaml/specify-path-to-yaml-file.png&#34; alt=&#34;specifying the path to the yaml file&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Having got this far, we can go ahead and select &amp;ldquo;Save and Queue&amp;rdquo;, and a new build will be created using the &amp;ldquo;Hello World&amp;rdquo; build definition we created earlier.&lt;/p&gt;

&lt;p&gt;If we look at the output of our build, we can see our text being written to the log.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://s3-eu-west-1.amazonaws.com/aksidjenakfjg/github-vsts-yaml/successful-build.png&#34; alt=&#34;building the trivial project&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Almost all of the elapsed time here was cloning the repo from GitHub, there is quite a lot of stuff in it!&lt;/p&gt;

&lt;h2 id=&#34;building-the-real-project&#34;&gt;Building the real project&lt;/h2&gt;

&lt;p&gt;This is all very well, but we haven&amp;rsquo;t managed to build our actual database project yet. To do so, we&amp;rsquo;ll need to go back to GitHub and edit the build definition file.&lt;/p&gt;

&lt;p&gt;The documentation for how to specify build steps in YAML is still a &lt;a href=&#34;https://github.com/Microsoft/vsts-agent/tree/master/docs/preview&#34;&gt;work in progress&lt;/a&gt;. In summary, the current procedure is to visit the &lt;a href=&#34;https://github.com/Microsoft/vsts-tasks/tree/master/Tasks&#34;&gt;VSTS Tasks repo on GitHub&lt;/a&gt;, open the folder for the task your are interested in, and take a look at the &lt;code&gt;task.json&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;In our case, the first task we need is &lt;a href=&#34;https://github.com/Microsoft/vsts-tasks/tree/master/Tasks/MSBuild&#34;&gt;MSBuild&lt;/a&gt;, to build the database project. Looking inside &lt;a href=&#34;https://github.com/Microsoft/vsts-tasks/blob/master/Tasks/MSBuild/task.json&#34;&gt;task.json&lt;/a&gt;, we can see that the name of the task we need is &lt;code&gt;MSBuild&lt;/code&gt;, and that there are a huge number of available &lt;code&gt;inputs&lt;/code&gt; we can use to configure the task; &lt;code&gt;solution&lt;/code&gt; to specify the project or solution to build, &lt;code&gt;platform&lt;/code&gt;, &lt;code&gt;configuration&lt;/code&gt;, and many more. In our case, we&amp;rsquo;ll just specify the path to our &lt;code&gt;.sqlproj&lt;/code&gt; file and let &lt;code&gt;msbuild&lt;/code&gt; take care of the rest.&lt;/p&gt;

&lt;p&gt;Having built the project, we need to copy our output somewhere so we can use it later. In this case, we&amp;rsquo;ll use the &amp;ldquo;Publish Build Artifacts&amp;rdquo; task to copy the built dacpac file to VSTS.&lt;/p&gt;

&lt;p&gt;The complete build definition is shown below. We build the database project with MSBuild, then specify the path to the built artifact to copy. The artifact itself needs a name, so we can reference it later, for instance in a Release Definition, as well as a type. &lt;code&gt;ArtifactType: Container&lt;/code&gt; just means that we are storing the artifact in VSTS, rather than in an external file share, for example.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;steps&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;-&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;task&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;MSBuild@&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;displayName&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;Build&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;the&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;database&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;project&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;inputs&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;solution&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;samples/databases/wide-world-importers/wwi-ssdt/wwi-ssdt/WideWorldImporters.sqlproj&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;-&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;task&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;PublishBuildArtifacts@&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;inputs&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;PathtoPublish&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;samples/databases/wide-world-importers/wwi-ssdt/wwi-ssdt/bin/Debug/WideWorldImporters.dacpac&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;ArtifactName&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;theDacpac&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;ArtifactType&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;Container&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If you take a glance at the history of this file, you&amp;rsquo;ll observe it took me a couple of attempts to get this working; the single quotes turned out to be more important than I originally anticipated. Having overcome that hurdle, we can see that the build succeeds, and produces a single artifact containing our &lt;code&gt;dacpac&lt;/code&gt; file.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://s3-eu-west-1.amazonaws.com/aksidjenakfjg/github-vsts-yaml/build-succeeded.png&#34; alt=&#34;build succeeded and produced an artifact&#34; /&gt;&lt;/p&gt;

&lt;p&gt;For now, this is where the story ends for YAML builds in VSTS, I&amp;rsquo;ll try to return to this topic later once YAML release management is publicly available.&lt;/p&gt;
&lt;div class=&#34;footnotes&#34;&gt;

&lt;hr /&gt;

&lt;ol&gt;
&lt;li id=&#34;fn:1&#34;&gt;Note that contrary to the current version of the docs, &amp;ldquo;Build YAML Definitions&amp;rdquo; is an account-scoped feature rather than a user-scoped feature, so if you&amp;rsquo;re following along at work this will enable it for every user in your VSTS Account.
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:1&#34;&gt;&lt;sup&gt;[return]&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
</description>
        </item>
      
    
      
        <item>
          <title>Automating SSDT build and deployment with Jenkins from a local git repo</title>
          <link>http://arapaima.uk/post/2017-04-04-jenkins-windows-git-ssdt-profit/</link>
          <pubDate>Tue, 04 Apr 2017 00:00:00 UTC</pubDate>
          <author>Gavin Campbell</author>
          <guid>http://arapaima.uk/post/2017-04-04-jenkins-windows-git-ssdt-profit/</guid>
          <description>

&lt;p&gt;This is a short illustration of using a local installation of Jenkins on Windows to build an SSDT project from a local git repo and deploy it to a SQL Server on the same machine.&lt;/p&gt;

&lt;p&gt;This is probably useful for a quick demonstration or to understand how the various moving parts fit together, but possibly less applicable to &amp;ldquo;Real Life&amp;rdquo; production environments.&lt;/p&gt;

&lt;p&gt;There are no build agents and no git remotes; all the action takes place on the Jenkins master, and the git repo is local to the same machine. No &amp;ldquo;git management&amp;rdquo; software such as GitHub/VSTS/GitLab/BitBucket/etc is involved (except for some slight cheating regarding the build definition itself.)&lt;/p&gt;

&lt;h2 id=&#34;getting-set-up&#34;&gt;Getting set up&lt;/h2&gt;

&lt;p&gt;I am using Windows 10 with SQL Server 2016 Developer Edition and Visual Studio 2015 Professional. Most of this stuff should work with most editions and versions of SQL Server and Visual Studio, but some of the paths will vary here and there. I am using SQL Server Data Tools Version 14.0.61021.0, released on October 26, 2016.&lt;/p&gt;

&lt;h3 id=&#34;installing-jenkins&#34;&gt;Installing Jenkins&lt;/h3&gt;

&lt;p&gt;I used the windows installer linked &lt;a href=&#34;https://jenkins.io/content/thank-you-downloading-windows-installer/#stable&#34;&gt;here&lt;/a&gt; (note that this link will trigger the download &lt;em&gt;immediately&lt;/em&gt;). At the time of writing this is version 2.46.1. In the initial setup, I selected the option to &amp;ldquo;Install Recommended Plugins&amp;rdquo;; this installs more than is required for this example.&lt;/p&gt;

&lt;h3 id=&#34;further-jenkins-twiddling&#34;&gt;Further Jenkins twiddling&lt;/h3&gt;

&lt;p&gt;The MSBuild plugin needs to be installed separately (as it isn&amp;rsquo;t &amp;ldquo;&lt;em&gt;recommended&lt;/em&gt;&amp;rdquo;!), which can be done from &lt;a href=&#34;http://localhost:8080/pluginManager/available&#34;&gt;http://localhost:8080/pluginManager/available&lt;/a&gt; or by clicking through &lt;em&gt;Jenkins -&amp;gt; Manage Jenkins -&amp;gt; Manage Plugins -&amp;gt; Available&lt;/em&gt;. We need to tell Jenkins where it can find &lt;code&gt;MSBuild.exe&lt;/code&gt;, this is done on &lt;a href=&#34;http://localhost:8080/configureTools/&#34;&gt;http://localhost:8080/configureTools/&lt;/a&gt; (&lt;em&gt;Jenkins -&amp;gt; Manage Jenkins -&amp;gt; Global Tool Configuration&lt;/em&gt;). You can find out where &lt;code&gt;MSBuild&lt;/code&gt; is installled by opening the &amp;ldquo;Developer Command Prompt for Visual Studio&amp;rdquo; and typing&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bat&#34; data-lang=&#34;bat&#34;&gt;C&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;nl&#34;&gt;\Program&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt; Files (x86)\Microsoft Visual Studio 14.0&amp;gt;where msbuild&lt;/span&gt;
C&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;nl&#34;&gt;\Program&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt; Files (x86)\MSBuild\14.0\Bin\MSBuild.exe&lt;/span&gt;
C&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;nl&#34;&gt;\Windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I used the first of these, as this is the one installed by Visual Studio&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:1&#34;&gt;&lt;a rel=&#34;footnote&#34; href=&#34;#fn:1&#34;&gt;1&lt;/a&gt;&lt;/sup&gt; 2015, and should avoid having to re-read the somewhat convoluted StackOverflow thread &lt;a href=&#34;http://stackoverflow.com/questions/22968561/msbuild-errors-for-database-project-on-tfs-server-with-vs-2013-shell&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I already had git installed and in the path, so there was no need to configure this separately in Jenkins.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ git --version
git version &lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;.11.0.windows.3&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&#34;compromising-your-sql-server-2&#34;&gt;Compromising your SQL Server &lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:2&#34;&gt;&lt;a rel=&#34;footnote&#34; href=&#34;#fn:2&#34;&gt;2&lt;/a&gt;&lt;/sup&gt;&lt;/h3&gt;

&lt;p&gt;By default, the Jenkins service will run as &amp;ldquo;Local System&amp;rdquo; on Windows. In order to allow this account - which will authenticate to SQL Server as the machine account - to deploy the database, I made &amp;ldquo;Local System&amp;rdquo; an &lt;code&gt;sa&lt;/code&gt; of the SQL Server:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;k&#34;&gt;EXEC&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;sp_addsrvrolemember&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;NT AUTHORITY\SYSTEM&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;sysadmin&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;There are many circumstances in which this wouldn&amp;rsquo;t be a good idea, if any of them apply in your scenario you should make appropriate adjustments to the scripts that follow.&lt;/p&gt;

&lt;h3 id=&#34;find-something-to-build&#34;&gt;Find something to build&lt;/h3&gt;

&lt;p&gt;I started by cloning a repo I had prepared earlier, containing a copy of the Chinook database.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bat&#34; data-lang=&#34;bat&#34;&gt;C&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;nl&#34;&gt;\Projects&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&amp;gt;git clone https://github.com/arapaima-uk/Chinook.JenkinsDemo.git&lt;/span&gt;
Cloning into &amp;#39;Chinook.JenkinsDemo&amp;#39;...
remote: Counting objects: 26, done.
remote: Compressing objects: 100% (20/20), done.
remote: Total 26 (delta 5), reused 26 (delta 5), pack-reused 0
Unpacking objects: 100% (26/26), done.

C&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;nl&#34;&gt;\Projects&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&amp;gt;tree&lt;/span&gt;
Folder PATH listing
Volume serial number is 000000B7 806E&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;nl&#34;&gt;E890&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;
C&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;nl&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;
└───Chinook.JenkinsDemo
    └───Chinook.JenkinsDemo
        └───dbo
            └───Tables

C&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;nl&#34;&gt;\Projects&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;having done that, I then removed the reference to the GitHub remote with&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bat&#34; data-lang=&#34;bat&#34;&gt;C&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;nl&#34;&gt;\Projects\Chinook.JenkinsDemo&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&amp;gt;git remote rm origin&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;From here on, everything is local (&lt;em&gt;geddit?&lt;/em&gt;).&lt;/p&gt;

&lt;h2 id=&#34;creating-the-jenkins-job&#34;&gt;Creating the Jenkins job&lt;/h2&gt;

&lt;p&gt;The first step is to create the Jenkins job that will build our project into a dacpac, and deploy it to a local SQL Server.&lt;/p&gt;

&lt;p&gt;The job definition is contained in the following Jenkinsfile, which consists of three fairly self-explanatory stages. The first stage &lt;code&gt;git checkout&lt;/code&gt; checks out our master branch from the local (indicated by the &lt;code&gt;file:\\&lt;/code&gt; prefix) repo. The second stage calls the &lt;code&gt;MSBuild&lt;/code&gt; tool we defined earlier, taking advantage of the fact that our project is very simple to provide very few parameters on the command line. The third calls out to the shell to call &lt;code&gt;sqlpackage.exe&lt;/code&gt;, again with very few parameters. This last stage is the one that requires whatever account Jenkins is running under to be able to authenticate to the SQL Server (though there are alternatives involving storing credentials in Jenkins).&lt;/p&gt;

&lt;script src=&#34;//gist.github.com/gavincampbell/e3dfa25abf427752e919eb2110f03852.js&#34;&gt;&lt;/script&gt;

&lt;p&gt;Conveniently, since this is stored in a GitHub gist, and a gist is a git repo, I can create a new pipeline job and specify &amp;ldquo;Pipeline Script from SCM&amp;rdquo; in the build definition then provide the url of the gist for the repository url.&lt;/p&gt;

&lt;p&gt;Note that this repo contains a single file, namely the build definition - all the project files are coming from the git repo on our local machine. If you want to copy and paste the complete url, it&amp;rsquo;s in the build output log reproduced below.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://s3-eu-west-1.amazonaws.com/aksidjenakfjg/jenkins-ssdt-git/pipeline-job-from-gist.PNG&#34; alt=&#34;Screenshot of Jenkins showing pipeline from SCM&#34; /&gt;&lt;/p&gt;

&lt;p&gt;One more detail is that the job needs to be set to &amp;ldquo;Poll SCM&amp;rdquo;, but the schedule can be left empty (ignore the warning). This isn&amp;rsquo;t required to test the build, but will be required later on to trigger the build on a commit to our git repo.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://s3-eu-west-1.amazonaws.com/aksidjenakfjg/jenkins-ssdt-git/jenkins-job-set-to-poll-with-empty-schedule.PNG&#34; alt=&#34;Jenkins Pipeline Job showing Poll SCM Setting with empty schedule&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;testing-the-build&#34;&gt;Testing the build&lt;/h3&gt;

&lt;p&gt;We should now be able to trigger the build from the Jenkins dashboard, and see some output like the following (under &amp;ldquo;Console Output&amp;rdquo;)&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Started by user arapaima
Obtained Jenkinsfile from git https://gist.github.com/gavincampbell/e3dfa25abf427752e919eb2110f03852
[Pipeline] node
Running on master in C:\Program Files (x86)\Jenkins\workspace\BuildDeploySsdtFromLocalRepo
[Pipeline] {
[Pipeline] stage
[Pipeline] { (git checkout)
[Pipeline] git
 &amp;gt; git.exe rev-parse --is-inside-work-tree # timeout=10
Fetching changes from the remote Git repository
 &amp;gt; git.exe config remote.origin.url file:///C:/Projects/Chinook.JenkinsDemo # timeout=10
Fetching upstream changes from file:///C:/Projects/Chinook.JenkinsDemo
 &amp;gt; git.exe --version # timeout=10
 &amp;gt; git.exe fetch --tags --progress file:///C:/Projects/Chinook.JenkinsDemo +refs/heads/*:refs/remotes/origin/*
 &amp;gt; git.exe rev-parse &amp;quot;refs/remotes/origin/master^{commit}&amp;quot; # timeout=10
 &amp;gt; git.exe rev-parse &amp;quot;refs/remotes/origin/origin/master^{commit}&amp;quot; # timeout=10
Checking out Revision 8ccbac95d2edd4ce0cbf14ec9f5f3f7ac2868eac (refs/remotes/origin/master)
 &amp;gt; git.exe config core.sparsecheckout # timeout=10
 &amp;gt; git.exe checkout -f 8ccbac95d2edd4ce0cbf14ec9f5f3f7ac2868eac
 &amp;gt; git.exe branch -a -v --no-abbrev # timeout=10
 &amp;gt; git.exe branch -D master # timeout=10
 &amp;gt; git.exe checkout -b master 8ccbac95d2edd4ce0cbf14ec9f5f3f7ac2868eac
 &amp;gt; git.exe rev-list 8ccbac95d2edd4ce0cbf14ec9f5f3f7ac2868eac # timeout=10
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Build Dacpac from SQLProj)
[Pipeline] tool
[Pipeline] bat
[BuildDeploySsdtFromLocalRepo] Running batch script

C:\Program Files (x86)\Jenkins\workspace\BuildDeploySsdtFromLocalRepo&amp;gt;&amp;quot;C:\Program Files (x86)\MSBuild\14.0\Bin\MSBuild.exe&amp;quot;  /p:Configuration=Release 
Microsoft (R) Build Engine version 14.0.25420.1
Copyright (C) Microsoft Corporation. All rights reserved.

Building the projects in this solution one at a time. To enable parallel build, please add the &amp;quot;/m&amp;quot; switch.
Build started 05/04/2017 00:55:50.
Project &amp;quot;C:\Program Files (x86)\Jenkins\workspace\BuildDeploySsdtFromLocalRepo\Chinook.JenkinsDemo.sln&amp;quot; on node 1 (default targets).
ValidateSolutionConfiguration:
  Building solution configuration &amp;quot;Release|Any CPU&amp;quot;.
Project &amp;quot;C:\Program Files (x86)\Jenkins\workspace\BuildDeploySsdtFromLocalRepo\Chinook.JenkinsDemo.sln&amp;quot; (1) is building &amp;quot;C:\Program Files (x86)\Jenkins\workspace\BuildDeploySsdtFromLocalRepo\Chinook.JenkinsDemo\Chinook.JenkinsDemo.sqlproj&amp;quot; (2) on node 1 (default targets).
GenerateSqlTargetFrameworkMoniker:
Skipping target &amp;quot;GenerateSqlTargetFrameworkMoniker&amp;quot; because all output files are up-to-date with respect to the input files.
CoreCompile:
Skipping target &amp;quot;CoreCompile&amp;quot; because all output files are up-to-date with respect to the input files.
SqlBuild:
Skipping target &amp;quot;SqlBuild&amp;quot; because all output files are up-to-date with respect to the input files.
CopyFilesToOutputDirectory:
  Chinook.JenkinsDemo -&amp;gt; C:\Program Files (x86)\Jenkins\workspace\BuildDeploySsdtFromLocalRepo\Chinook.JenkinsDemo\bin\Release\Chinook.JenkinsDemo.dll
SqlPrepareForRun:
  Chinook.JenkinsDemo -&amp;gt; C:\Program Files (x86)\Jenkins\workspace\BuildDeploySsdtFromLocalRepo\Chinook.JenkinsDemo\bin\Release\Chinook.JenkinsDemo.dacpac
Done Building Project &amp;quot;C:\Program Files (x86)\Jenkins\workspace\BuildDeploySsdtFromLocalRepo\Chinook.JenkinsDemo\Chinook.JenkinsDemo.sqlproj&amp;quot; (default targets).
Done Building Project &amp;quot;C:\Program Files (x86)\Jenkins\workspace\BuildDeploySsdtFromLocalRepo\Chinook.JenkinsDemo.sln&amp;quot; (default targets).

Build succeeded.
    0 Warning(s)
    0 Error(s)

Time Elapsed 00:00:00.53
[Pipeline] stash
Stashed 1 file(s)
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Deploy Dacpac to SQL Server)
[Pipeline] unstash
[Pipeline] bat
[BuildDeploySsdtFromLocalRepo] Running batch script

C:\Program Files (x86)\Jenkins\workspace\BuildDeploySsdtFromLocalRepo&amp;gt;&amp;quot;C:\Program Files (x86)\Microsoft SQL Server\130\DAC\bin\sqlpackage.exe&amp;quot; /Action:Publish /SourceFile:&amp;quot;Chinook.JenkinsDemo\bin\Release\Chinook.JenkinsDemo.dacpac&amp;quot; /TargetServerName:(local) /TargetDatabaseName:Chinook 
Publishing to database &#39;Chinook&#39; on server &#39;(local)&#39;.
Initializing deployment (Start)
Initializing deployment (Complete)
Analyzing deployment plan (Start)
Analyzing deployment plan (Complete)
Updating database (Start)
Update complete.
Updating database (Complete)
Successfully published database.
[Pipeline] }
[Pipeline] // stage
[Pipeline] }
[Pipeline] // node
[Pipeline] End of Pipeline
Finished: SUCCESS

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &amp;ldquo;stage view&amp;rdquo; of the build should be showing green:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://s3-eu-west-1.amazonaws.com/aksidjenakfjg/jenkins-ssdt-git/passing-stage-view.PNG&#34; alt=&#34;passing builds in Jenkins&#34; title=&#34;Earlier builds omitted for clarity, naturally!&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;triggering-the-build-from-the-git-repo&#34;&gt;Triggering the build from the git repo&lt;/h2&gt;

&lt;p&gt;Many approaches to building a project automatically on each commit rely on the CI server, in this case Jenkins, polling the source control system at some pre-defined interval.&lt;/p&gt;

&lt;p&gt;However, if the geo-political events of 2016 are any guide, polling doesn&amp;rsquo;t always lead to the outcome we expect, so in this case we&amp;rsquo;ll create a git &amp;ldquo;hook&amp;rdquo; to trigger the build on every commit to master.&lt;/p&gt;

&lt;p&gt;A &lt;a href=&#34;https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks&#34; title=&#34;Link to git hooks chapter of git book&#34;&gt;git hook&lt;/a&gt; is a script that runs in response to a specific event that occurs in git. There are a bunch of events that can fire hooks, these can be used to enforce commit message conventions, run static code analysis, prevent force-pushes, and all kinds of other arbitrary busywork. The event that&amp;rsquo;s of interest here is the &lt;code&gt;post-commit&lt;/code&gt; hook, which runs &lt;em&gt;after&lt;/em&gt; a commit has been added. In &amp;ldquo;Real Life&amp;rdquo;, hooks are normally added to the &lt;em&gt;server&lt;/em&gt; copy of the repo but since there&amp;rsquo;s no remote in our setup, everything has to be local.&lt;/p&gt;

&lt;p&gt;Notably, even though we&amp;rsquo;re on Windows in this example, hooks are executed by the &lt;code&gt;msysgit&lt;/code&gt; subsystem so much of the usual UNIX shell stuff will work.&lt;/p&gt;

&lt;p&gt;Hooks are stored in the &lt;code&gt;.git&lt;/code&gt; folder in our repo (this is usually hidden on Windows) in files that match the name of the hook. So, our file is called &lt;code&gt;post-commit&lt;/code&gt; (no extension) and contains the &lt;code&gt;#!/bin/sh&lt;/code&gt; &amp;ldquo;shebang&amp;rdquo; plus a single line that uses &lt;code&gt;curl&lt;/code&gt; to hit a specific URL in the Jenkins server that will cause our Jenkins job to poll its source repo as defined in the build pipeline (i.e. &lt;code&gt;file:///C:/Projects/Chinook.JenkinsDemo&lt;/code&gt; )&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bat&#34; data-lang=&#34;bat&#34;&gt;C&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;nl&#34;&gt;\Projects\Chinook.JenkinsDemo\.git\hooks&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&amp;gt;type post-commit&lt;/span&gt;
#!/bin/sh
curl http://localhost:8080/git/notifyCommit?url=file:///C:/Projects/Chinook.JenkinsDemo&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;blockquote&gt;
&lt;p&gt;Note for &lt;code&gt;git&lt;/code&gt; beginners: this file isn&amp;rsquo;t in the repo when you download it, you&amp;rsquo;ll need to add it yourself!&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Now, all that remains is to make an arbitrary change to our project and add a commit.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://s3-eu-west-1.amazonaws.com/aksidjenakfjg/jenkins-ssdt-git/changed-table-with-commit-dialog.PNG&#34; alt=&#34;Visual Studio showing changed table and commit dialog&#34; /&gt;&lt;/p&gt;

&lt;p&gt;If everything is working the pipeline job should be triggered, and the new build will also log that it was &amp;ldquo;Started by an SCM Change&amp;rdquo;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://s3-eu-west-1.amazonaws.com/aksidjenakfjg/jenkins-ssdt-git/build-started-by-scm-change.PNG&#34; alt=&#34;Build Triggered by SCM Change&#34; /&gt;&lt;/p&gt;

&lt;p&gt;To clarify what&amp;rsquo;s happened here, we made a change and committed it to our local repo, the &lt;code&gt;post-commit&lt;/code&gt; hook called the url in Jenkins, and Jenkins then &amp;ldquo;polled&amp;rdquo; the git repo, found a new commit, and triggered the pipeline job.&lt;/p&gt;

&lt;p&gt;Until next time, happy triggering!&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;If you commit the change from the &lt;code&gt;git&lt;/code&gt; command line, you may see output along the lines of:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ git commit -am &amp;quot;add shoesize to artist table&amp;quot;
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   135  100   135    0     0   9000      0 --:--:-- --:--:-- --:--:--  9000Scheduled polling of BuildDeploySsdtFromLocalRepo
No Git consumers using SCM API plugin for: file:///C:/Projects/Chinook.JenkinsDemo

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &amp;ldquo;error&amp;rdquo; message is nothing to worry about, as long as the line &amp;ldquo;Scheduled Polling of &lt;em&gt;myJobName&lt;/em&gt; is present then everything is hunky-dory!&lt;/p&gt;
&lt;/blockquote&gt;
&lt;div class=&#34;footnotes&#34;&gt;

&lt;hr /&gt;

&lt;ol&gt;
&lt;li id=&#34;fn:1&#34;&gt;&lt;a href=&#34;https://blogs.msdn.microsoft.com/visualstudio/2013/07/24/msbuild-is-now-part-of-visual-studio/&#34;&gt;MSBuild is now part of Visual Studio!&lt;/a&gt;
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:1&#34;&gt;&lt;sup&gt;[return]&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li id=&#34;fn:2&#34;&gt;&lt;a href=&#34;https://blogs.msdn.microsoft.com/dataaccesstechnologies/2010/01/29/testing-connection-to-sql-server-from-a-service-running-under-local-system-account/&#34;&gt;Testing connection to SQL Server from a service running under Local System Account&lt;/a&gt;
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:2&#34;&gt;&lt;sup&gt;[return]&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
</description>
        </item>
      
    
      
        <item>
          <title>Recovering from the &#34;La-La-Land Moment&#34;</title>
          <link>http://arapaima.uk/post/2017-03-16-inserting-marked-transaction-ssdt-deployment/</link>
          <pubDate>Thu, 16 Mar 2017 00:00:00 UTC</pubDate>
          <author>Gavin Campbell</author>
          <guid>http://arapaima.uk/post/2017-03-16-inserting-marked-transaction-ssdt-deployment/</guid>
          <description>

&lt;h1 id=&#34;how-ssdt-can-help-with-restoring-a-sql-server-database-to-just-before-that-last-deployment&#34;&gt;How SSDT can help with restoring a SQL Server database to &amp;ldquo;just before that last deployment&amp;rdquo;&lt;/h1&gt;

&lt;p&gt;For as long as I can remember, SSDT and its predecessors have had the option to &amp;ldquo;Back up database before deployment&amp;rdquo;, currently available in the &amp;ldquo;Advanced Publish Settings&amp;rdquo; dialog, among other places. Regrettably, I&amp;rsquo;ve never really had much use for this particular option. Whilst restoring from backup might be a valid strategy for recovering from some kinds of deployment disaster, this could add a great deal of time to the deployment process, assuming a database of non-trivial size.&lt;/p&gt;

&lt;p&gt;In any case, there are really only two kinds of database - the ones where you don&amp;rsquo;t care about the data, such as development and test environments, and the ones (one?) where you do. In the former case, backups don&amp;rsquo;t matter anyway, and in the latter case it is to be hoped that there is already some kind of backup solution in place, ideally managed by someone who isn&amp;rsquo;t you.&lt;/p&gt;

&lt;p&gt;Further, the &amp;ldquo;Backup database before deployment&amp;rdquo; option appears not to offer much control over &lt;em&gt;how&lt;/em&gt; the database is backed up. The backup will be created in the default backup directory of the instance, and will be a &lt;em&gt;full&lt;/em&gt; rather than a &lt;em&gt;copy only&lt;/em&gt; backup, which has the potential to endanger the &amp;ldquo;real&amp;rdquo; disaster recovery plans in the event that these include differential database backups, as the SSDT-generated backup will reset the differential base, meaning &lt;em&gt;this&lt;/em&gt; backup, which the DBAs don&amp;rsquo;t even know about,  will be necessary, along with the subsequent differentials, in case the database needs to be restored.&lt;/p&gt;

&lt;p&gt;It&amp;rsquo;s likely that the &amp;ldquo;real&amp;rdquo; backup strategy will involve some combination of full, differential, and transaction log backups, and if you&amp;rsquo;re especially lucky will be managed by some kind of &amp;ldquo;Enterprise Backup Solution&amp;rdquo;, which will allow rapid restores to any point in time, just as soon as you figure out where it is that the &amp;ldquo;Enterprise Backup Solution&amp;rdquo; keeps the backup files for your database.&lt;/p&gt;

&lt;p&gt;So, assuming the worst case scenario has arisen, your newly deployed release has been writing rubbish data to the database for the last few hours, the &amp;ldquo;war room&amp;rdquo; has been convened and someone you&amp;rsquo;ve never heard of called the &amp;ldquo;Problem Management Executive Consultant&amp;rdquo; has decided that the right course of action is to &amp;ldquo;Restore the database to immediately before the deployment&amp;rdquo;, how are you to decide when this was?&lt;/p&gt;

&lt;p&gt;Well, hopefully you know from your release logs what time the database was deployed, but what if there was a better way? And what if you aren&amp;rsquo;t sure what timezone the deployment server is in or whether it uses daylight savings time? Well, one solution to this involves a somewhat neglected feature of SQL Server known as &lt;a href=&#34;https://msdn.microsoft.com/en-us/library/ms188929.aspx#Anchor_3&#34;&gt;Marked Transactions&lt;/a&gt;. (See, it doesn&amp;rsquo;t even get its own page in MSDN!)&lt;/p&gt;

&lt;h2 id=&#34;marked-transactions&#34;&gt;Marked Transactions&lt;/h2&gt;

&lt;p&gt;The syntax &lt;code&gt;BEGIN TRANSACTION&lt;/code&gt; &lt;em&gt;tran-name&lt;/em&gt; &lt;code&gt;WITH MARK &#39;Mark Description&#39;&lt;/code&gt; will record the name of the transaction in the transaction log, along with the date, time, LSN, etc. The description is optional, but that gets saved too.&lt;/p&gt;

&lt;p&gt;We can see this in action using the &lt;a href=&#34;https://technet.microsoft.com/en-us/library/ms143221.aspx&#34;&gt;&lt;code&gt;pubs&lt;/code&gt;&lt;/a&gt; database, which if you&amp;rsquo;re younger than a certain age, sadly isn&amp;rsquo;t what you think.&lt;/p&gt;

&lt;p&gt;Note that if you&amp;rsquo;re playing along at home, there are a couple of extra considerations; the database needs to be using the full (or bulk-logged) recovery model and &lt;em&gt;a full backup must already have been taken&lt;/em&gt;, i.e. the database is not in the &lt;a href=&#34;http://www.sqlskills.com/blogs/paul/new-script-is-that-database-really-in-the-full-recovery-mode/&#34;&gt;pseudo-simple&lt;/a&gt; recovery model.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-SQL&#34; data-lang=&#34;SQL&#34;&gt;&lt;span class=&#34;n&#34;&gt;USE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;pubs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;GO&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;BEGIN&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;TRANSACTION&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;update_auths&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;WITH&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;MARK&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;update authors entry&amp;#39;&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;UPDATE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;authors&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;set&lt;/span&gt; 
&lt;span class=&#34;n&#34;&gt;phone&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;408 496-7223&amp;#39;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;au_id&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;172-32-1176&amp;#39;&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;COMMIT&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;TRANSACTION&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If we take a peek at the transaction log we can see our marked transaction there:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-SQL&#34; data-lang=&#34;SQL&#34;&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;  &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Transaction&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;ID&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
        &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Current&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;LSN&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
        &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Transaction&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
        &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Operation&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
        &lt;span class=&#34;n&#34;&gt;Description&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
        &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Transaction&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;SID&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
        &lt;span class=&#34;n&#34;&gt;sp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;    &lt;span class=&#34;n&#34;&gt;fn_dblog&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;JOIN&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;sys&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;server_principals&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;sp&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;ON&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Transaction&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;SID&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;sp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sid&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;   &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;transaction&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;update_auths&amp;#39;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Transaction ID&lt;/th&gt;
&lt;th&gt;Current LSN&lt;/th&gt;
&lt;th&gt;Transaction Name&lt;/th&gt;
&lt;th&gt;Operation&lt;/th&gt;
&lt;th&gt;Description&lt;/th&gt;
&lt;th&gt;Transaction SID&lt;/th&gt;
&lt;th&gt;name&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;0000:000004ee&lt;/td&gt;
&lt;td&gt;00000022:000005f2:0001&lt;/td&gt;
&lt;td&gt;update_auths&lt;/td&gt;
&lt;td&gt;LOP_BEGIN_XACT&lt;/td&gt;
&lt;td&gt;2017/03/16 18:09:58:327;update_auths;0x0105000000000005150000004cca9a3fa9173a6eba0c5dc9e9030000&lt;/td&gt;
&lt;td&gt;0x0105000000000005150000004CCA9A3FA9173A6EBA0C5DC9E9030000&lt;/td&gt;
&lt;td&gt;ARAPAIMA\Arapaima&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;The &lt;code&gt;logmarkhistory&lt;/code&gt; table in &lt;code&gt;msdb&lt;/code&gt; also stores a list of our marked transactions:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-SQL&#34; data-lang=&#34;SQL&#34;&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;msdb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;logmarkhistory&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;database_name&lt;/th&gt;
&lt;th&gt;mark_name&lt;/th&gt;
&lt;th&gt;description&lt;/th&gt;
&lt;th&gt;user_name&lt;/th&gt;
&lt;th&gt;lsn&lt;/th&gt;
&lt;th&gt;mark_time&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;pubs&lt;/td&gt;
&lt;td&gt;update_auths&lt;/td&gt;
&lt;td&gt;update authors entry&lt;/td&gt;
&lt;td&gt;ARAPAIMA\Arapaima&lt;/td&gt;
&lt;td&gt;34000000152200003&lt;/td&gt;
&lt;td&gt;2017-03-16 18:09:58.327&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;So, it seems we can use this functionality to give us a named point in the transaction log to restore to in the event of career-threatening disaster.&lt;/p&gt;

&lt;p&gt;The thing to note is that we need to update &lt;em&gt;something&lt;/em&gt; in the database where we&amp;rsquo;re creating the mark, but it doesn&amp;rsquo;t really matter &lt;em&gt;what&lt;/em&gt; we update. It&amp;rsquo;s often useful to have a &lt;code&gt;Releases&lt;/code&gt; table in our databases where we can store the version number, date, and other fun facts about our database, so this is as good a candidate as any.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-SQL&#34; data-lang=&#34;SQL&#34;&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dbo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;].[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Releases&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
        &lt;span class=&#34;n&#34;&gt;ReleaseVersion&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;VARCHAR&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;20&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;PRIMARY&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;KEY&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
        &lt;span class=&#34;n&#34;&gt;DateDeployed&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;DATETIME2&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;SYSUTCDATETIME&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; 
        &lt;span class=&#34;c1&#34;&gt;--Not taking any chances with the time zone!
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We need to create this table and add it to our database project.&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;ve created a proc to do the inserting:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-SQL&#34; data-lang=&#34;SQL&#34;&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;PROCEDURE&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dbo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;].[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;spFireInTheHole&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;
	&lt;span class=&#34;o&#34;&gt;@&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ReleaseVersion&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;20&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;BEGIN&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;TRANSACTION&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;@&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ReleaseVersion&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;WITH&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;MARK&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;@&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ReleaseVersion&lt;/span&gt; 
  &lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;dbo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Releases&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ReleaseVersion&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;VALUES&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;@&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ReleaseVersion&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;COMMIT&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;TRANSACTION&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;RETURN&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And now for the tricky part&amp;hellip;&lt;/p&gt;

&lt;p&gt;The &lt;em&gt;first&lt;/em&gt; time we deploy the database project after adding these objects, they won&amp;rsquo;t be present in the target database, so we won&amp;rsquo;t be able to call them from the pre-deployment script. This means we need to wrap them with &lt;code&gt;IF EXISTS&lt;/code&gt; in the pre-deployment script so that they don&amp;rsquo;t get called if they don&amp;rsquo;t exist. The drawback of this approach, naturally, is that &amp;ldquo;Release 0.0.1&amp;rdquo; won&amp;rsquo;t be recorded in your database for posterity. In my experience of such matters, the gap between Release 0.0.1 and Release 0.0.2 is normally measured in minutes rather than years, so I&amp;rsquo;m not particularly concerned about this.&lt;/p&gt;

&lt;p&gt;Finally, we are going to use a &lt;code&gt;sqlcmd&lt;/code&gt; &lt;em&gt;variable&lt;/em&gt; to hold the release number; this means we can pass it in at deployment time. Most deployment tools know how to do this, for this example we&amp;rsquo;ll just pass it on the command line.&lt;/p&gt;

&lt;h3 id=&#34;the-pre-deployment-script&#34;&gt;The pre-deployment script&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-SQL&#34; data-lang=&#34;SQL&#34;&gt;&lt;span class=&#34;cm&#34;&gt;/*
&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt; Pre-Deployment Script Template							
&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;--------------------------------------------------------------------------------------
&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt; This file contains SQL statements that will be executed before the build script.	
&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt; Use SQLCMD syntax to include a file in the pre-deployment script.			
&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt; Example:      :r .\myfile.sql								
&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt; Use SQLCMD syntax to reference a variable in the pre-deployment script.		
&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt; Example:      :setvar TableName MyTable							
&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;               SELECT * FROM [$(TableName)]					
&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;--------------------------------------------------------------------------------------
&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;*/&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;IF&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;EXISTS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;sys&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tables&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;where&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;name&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;Releases&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; 
&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt; 
&lt;span class=&#34;k&#34;&gt;EXISTS&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;sys&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;procedures&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;NAME&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;spFireInTheHole&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;BEGIN&lt;/span&gt;
	
        &lt;span class=&#34;k&#34;&gt;EXEC&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;spFireInTheHole&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;@&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ReleaseVersion&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;$(ReleaseVersion)&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;END&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now, after we build our &lt;code&gt;dacpac&lt;/code&gt;, we supply the version number at deploy time:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sqlpackage.exe /Action:Publish /SourceFile:pubs.dacpac /TargetServerName:(local) /TargetDatabaseName:pubs /v:ReleaseVersion=0.2.0

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If we run a few &amp;ldquo;Releases&amp;rdquo;, we can see the marks building up in &lt;code&gt;msdb..logmarkhistory&lt;/code&gt;:&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;database name&lt;/th&gt;
&lt;th&gt;mark name&lt;/th&gt;
&lt;th&gt;description&lt;/th&gt;
&lt;th&gt;user name&lt;/th&gt;
&lt;th&gt;lsn&lt;/th&gt;
&lt;th&gt;mark_time&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;pubs&lt;/td&gt;
&lt;td&gt;0.0.2&lt;/td&gt;
&lt;td&gt;0.0.2&lt;/td&gt;
&lt;td&gt;ARAPAIMA\Arapaima&lt;/td&gt;
&lt;td&gt;34000000172100002&lt;/td&gt;
&lt;td&gt;2017-03-16 20:06:40.490&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;pubs&lt;/td&gt;
&lt;td&gt;0.0.3&lt;/td&gt;
&lt;td&gt;0.0.3&lt;/td&gt;
&lt;td&gt;ARAPAIMA\Arapaima&lt;/td&gt;
&lt;td&gt;34000000172200003&lt;/td&gt;
&lt;td&gt;2017-03-16 20:07:14.673&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;pubs&lt;/td&gt;
&lt;td&gt;0.0.3&lt;/td&gt;
&lt;td&gt;0.0.3&lt;/td&gt;
&lt;td&gt;ARAPAIMA\Arapaima&lt;/td&gt;
&lt;td&gt;34000000172300002&lt;/td&gt;
&lt;td&gt;2017-03-16 20:08:16.183&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;pubs&lt;/td&gt;
&lt;td&gt;0.0.4&lt;/td&gt;
&lt;td&gt;0.0.4&lt;/td&gt;
&lt;td&gt;ARAPAIMA\Arapaima&lt;/td&gt;
&lt;td&gt;34000000172400003&lt;/td&gt;
&lt;td&gt;2017-03-16 20:08:39.760&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;In this particular setup, you&amp;rsquo;ll get an error if you try to supply the same version number more than once, as &lt;code&gt;ReleaseVersion&lt;/code&gt; is the primary key of the &lt;code&gt;Releases&lt;/code&gt; table.&lt;/p&gt;

&lt;h3 id=&#34;disaster-strikes&#34;&gt;Disaster Strikes&lt;/h3&gt;

&lt;p&gt;So, the career-threatening disaster has happened, and we need to restore our database to its state immediately prior to release 0.6.0. If there hasn&amp;rsquo;t been a log backup since the deployment, the first step is to make one.&lt;/p&gt;

&lt;p&gt;Then, with a bit of DBA magic, we can restore our database to just before the deployment started. I generated these scripts from SQL Server Management Studio, unless you&amp;rsquo;ve got a competent adult handy I suggest you do the same. The crucial bit is in the last line where we specify &lt;code&gt;STOPBEFOREMARK&lt;/code&gt;, which is exactly what we want to do.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-SQL&#34; data-lang=&#34;SQL&#34;&gt;&lt;span class=&#34;n&#34;&gt;USE&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;master&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;BACKUP&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;LOG&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pubs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;TO&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;DISK&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;N&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\Backup\pubs_LogBackup_2017-03-16_21-05-56.bak&amp;#39;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;WITH&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;NOFORMAT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;NOINIT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;NAME&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;N&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;pubs_LogBackup_2017-03-16_21-05-56&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;NOSKIP&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;NOREWIND&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;NOUNLOAD&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;NORECOVERY&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;STATS&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;RESTORE&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;DATABASE&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pubs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;DISK&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;N&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\Backup\pubs.bak&amp;#39;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;WITH&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;FILE&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;NORECOVERY&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;NOUNLOAD&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;STATS&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;GO&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;RESTORE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;LOG&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pubs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;DISK&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;N&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\Backup\pubs.bak&amp;#39;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;WITH&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;FILE&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;NORECOVERY&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;NOUNLOAD&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;STATS&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;GO&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;RESTORE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;LOG&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pubs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;DISK&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;N&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\Backup\pubs.bak&amp;#39;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;WITH&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;FILE&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;NORECOVERY&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;NOUNLOAD&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;STATS&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;GO&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;RESTORE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;LOG&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pubs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;DISK&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;N&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\Backup\pubs.bak&amp;#39;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;WITH&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;FILE&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;NOUNLOAD&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;STATS&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;STOPBEFOREMARK&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;N&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0.6.0&amp;#39;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;AFTER&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;N&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2017-03-16T20:46:07&amp;#39;&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;GO&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And with that, the database is restored to its state immediately prior to the deployment - you can check this by looking at the &lt;code&gt;Releases&lt;/code&gt; table - , and all that is left to do is blame the guy that left last month for the &amp;ldquo;rogue code&amp;rdquo; that &amp;ldquo;crept&amp;rdquo; into the release. This is normally possible by editing old git commit messages and force pushing the master branch, but that&amp;rsquo;s a topic for another day.&lt;/p&gt;
</description>
        </item>
      
    
      
        <item>
          <title>What&#39;s in a name?</title>
          <link>http://arapaima.uk/post/2016-11-12-database-refactoring-ssdt-renaming-objects/</link>
          <pubDate>Sat, 12 Nov 2016 00:00:00 UTC</pubDate>
          <author>Gavin Campbell</author>
          <guid>http://arapaima.uk/post/2016-11-12-database-refactoring-ssdt-renaming-objects/</guid>
          <description>

&lt;p&gt;Continuing our horticultural theme, in this article we&amp;rsquo;ll look at the built-in support in SSDT for renaming database objects including tables, columns, and programmable objects, as well as peering into the details of how these changes are managed at deployment time.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://upload.wikimedia.org/wikipedia/commons/6/66/Rosa_laxa.jpg&#34; alt=&#34;That which we call a rose. By any other name would smell as sweet&#34; title=&#34;That which we call a rose. By any other name would smell as sweet&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;renaming-columns&#34;&gt;Renaming columns&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;Refactoring Databases, p 109&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&#34;the-easy-way&#34;&gt;The easy way&lt;/h3&gt;

&lt;p&gt;We can rename a column just by right-clicking in the &lt;code&gt;CREATE TABLE&lt;/code&gt; script and selecting Refactor &amp;rarr; Rename.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://aksidjenakfjg.s3.amazonaws.com/ssdt-refactoring-part-2/RefactorRenameSelected.PNG&#34; alt=&#34;Renaming the InvoiceId Column by right-clicking in the editor window&#34; title=&#34;Renaming the InvoiceId Column by right-clicking in the editor window&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Under normal circumstances, renaming the Primary Key column of a table such as &amp;ldquo;Invoices&amp;rdquo; would be a recipe for disaster, but SSDT can help to ease such changes by automatically updating all references to the column to use the new name. In this case we are renaming the column InvoiceId to Invoice_Id, and by specifying the option to preview the changes, we can see a list of all the objects that reference this column by its old name.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://aksidjenakfjg.s3.amazonaws.com/ssdt-refactoring-part-2/rename%20column%20preview.PNG&#34; alt=&#34;SSDT shows a preview of which objects will be updated to refer to the new name&#34; title=&#34;SSDT shows a preview of which objects will be updated to refer to the new name&#34; /&gt;&lt;/p&gt;

&lt;p&gt;There&amp;rsquo;s something of note here, which is that &lt;em&gt;only&lt;/em&gt; the InvoiceId column from the Invoices table is being renamed, any other columns called InvoiceId (such as the one in the InvoiceLine table) are unaffected. The foreign key constraint on that particular column, however, &lt;em&gt;is&lt;/em&gt; updated to use the new name of the referenced column.&lt;/p&gt;

&lt;p&gt;What this demonstrates is that there is something more than global search and replace going on here; SSDT is using its in-memory model of the database to determine which changes need to be made&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:1&#34;&gt;&lt;a rel=&#34;footnote&#34; href=&#34;#fn:1&#34;&gt;1&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;

&lt;h3 id=&#34;the-refactorlog&#34;&gt;The refactorlog&lt;/h3&gt;

&lt;p&gt;When we click apply, two things happen. The first is that all the references to this column are updated to use the new name. The second is that a new file appears in the solution, with the extension &lt;code&gt;.refactorlog&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-xml&#34; data-lang=&#34;xml&#34;&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;?xml version=&amp;#34;1.0&amp;#34; encoding=&amp;#34;utf-8&amp;#34;?&amp;gt;&lt;/span&gt;
&lt;span class=&#34;nt&#34;&gt;&amp;lt;Operations&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Version=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;1.0&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;xmlns=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;http://schemas.microsoft.com/sqlserver/dac/Serialization/2012/02&amp;#34;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;&amp;gt;&lt;/span&gt;
  &lt;span class=&#34;nt&#34;&gt;&amp;lt;Operation&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;Rename Refactor&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Key=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;209f3afd-7195-401f-853f-aa3a906d39db&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;ChangeDateTime=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;11/08/2016 20:02:31&amp;#34;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;&amp;gt;&lt;/span&gt;
  &lt;span class=&#34;nt&#34;&gt;&amp;lt;Property&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;ElementName&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Value=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;[dbo].[Invoice].[InvoiceId]&amp;#34;&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;/&amp;gt;&lt;/span&gt;
  &lt;span class=&#34;nt&#34;&gt;&amp;lt;Property&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;ElementType&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Value=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;SqlSimpleColumn&amp;#34;&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;/&amp;gt;&lt;/span&gt;
  &lt;span class=&#34;nt&#34;&gt;&amp;lt;Property&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;ParentElementName&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Value=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;[dbo].[Invoice]&amp;#34;&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;/&amp;gt;&lt;/span&gt;
  &lt;span class=&#34;nt&#34;&gt;&amp;lt;Property&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;ParentElementType&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Value=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;SqlTable&amp;#34;&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;/&amp;gt;&lt;/span&gt;
  &lt;span class=&#34;nt&#34;&gt;&amp;lt;Property&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;NewName&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Value=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;[Invoice_Id]&amp;#34;&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;/&amp;gt;&lt;/span&gt;
  &lt;span class=&#34;nt&#34;&gt;&amp;lt;/Operation&amp;gt;&lt;/span&gt;
&lt;span class=&#34;nt&#34;&gt;&amp;lt;/Operations&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This file is how &lt;code&gt;sqlpackage.exe&lt;/code&gt; (or SSDT publish, or DacFX.Deploy) will detemine &lt;em&gt;at deploy time&lt;/em&gt; that we are renaming this column from InvoiceID to Invoice_Id rather than dropping the InvoiceID column and creating a new column called Invoice_ID. We can see in the XML that this is specifying the column and table name, and the precise action to perform. This is known, in the jargon, as &amp;ldquo;preserving the intent&amp;rdquo; of the refactoring. If we build a project containing a &lt;code&gt;.refactorlog&lt;/code&gt; file and examine the resulting &lt;code&gt;.dacpac&lt;/code&gt;, we can see that the regular &lt;code&gt;.dacpac&lt;/code&gt; contents have been joined by a &lt;code&gt;refactor.xml&lt;/code&gt; file.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bat&#34; data-lang=&#34;bat&#34;&gt;$ unzip -l Refactoring.Chinook.dacpac
Archive:  Refactoring.Chinook.dacpac
  Length      Date    Time    Name
---------  ---------- -----   ----
    69711  2016-11-10 05&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;nl&#34;&gt;44&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;   model.xml&lt;/span&gt;
      606  2016-11-10 05&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;nl&#34;&gt;44&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;   refactor.xml&lt;/span&gt;
      203  2016-11-10 05&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;nl&#34;&gt;44&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;   DacMetadata.xml&lt;/span&gt;
     1118  2016-11-10 05&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;nl&#34;&gt;44&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;   Origin.xml&lt;/span&gt;
      175  2016-11-10 05&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;nl&#34;&gt;44&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;   [Content_Types].xml&lt;/span&gt;
---------                     -------
    71813                     5 files&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The contents of this file are the same as the &lt;code&gt;.refactorlog&lt;/code&gt; file from our solution.&lt;/p&gt;

&lt;p&gt;When we publish the project we see the following output:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bat&#34; data-lang=&#34;bat&#34;&gt;The following operation was generated from a refactoring log file 209f3afd-7195-401f-853f-aa3a906d39db
&lt;span class=&#34;k&#34;&gt;Rename&lt;/span&gt; [dbo].[Invoice].[InvoiceId] to Invoice_Id
Caution: Changing any part of an object name could break scripts and stored procedures.

Altering [dbo].[InvoicesWithLineTotals]...
Altering [dbo].[UpdateInvoiceBillingAddress]...
Update complete.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The publish action has read the &lt;code&gt;refactorlog&lt;/code&gt; file and taken the appropriate action. In addition, the &amp;ldquo;key&amp;rdquo; for this refactoring has been stored in a new table in our database called &lt;code&gt;dbo._RefactorLog&lt;/code&gt;, which gets created the first time we deploy a dacpac containing a &lt;code&gt;refactor.xml&lt;/code&gt; file:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- Refactoring step to update target server with deployed transaction logs
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;IF&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;EXISTS&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;OperationKey&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dbo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;].[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__RefactorLog&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;OperationKey&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;209f3afd-7195-401f-853f-aa3a906d39db&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dbo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;].[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__RefactorLog&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;OperationKey&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;values&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;209f3afd-7195-401f-853f-aa3a906d39db&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;On subsequent deployments, this table is read and any refactorings recorded here are skipped from the deployment.&lt;/p&gt;

&lt;h3 id=&#34;appearances-can-be-deceptive&#34;&gt;Appearances can be deceptive&lt;/h3&gt;

&lt;p&gt;There&amp;rsquo;s another UI wrinkle here which is worth examining, so we will rename another column, this time using the table designer.&lt;/p&gt;

&lt;p&gt;Another entry has been added to the &lt;code&gt;refactorlog&lt;/code&gt; file, and it appears as if the references to this column elsewhere in the model have been updated (note the red tick showing that &lt;code&gt;PlaylistTrack.sql&lt;/code&gt; and &lt;code&gt;InvoiceLine.sql&lt;/code&gt; have been modified.)
&lt;img src=&#34;http://aksidjenakfjg.s3.amazonaws.com/ssdt-refactoring-part-2/Renaming%20a%20Column%20in%20the%20table%20designer.PNG&#34; alt=&#34;Renaming a column using the table designer&#34; title=&#34;Renaming a column using the table designer&#34; /&gt;
However, when we go to build the project, we get an error:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;SQL71501: Procedure: [dbo].[ChangeTrackPriceByFactor] has an unresolved reference to object [dbo].[Track].[TrackId].	
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;(Alternatively, the error will appear in the SSDT UI as soon as the Intellisense catches up). There was a stored procedure referencing this column by name, which is now causing the build to fail (remember that &lt;a href=&#34;http://arapaima.uk/post/2016-10-25-database-refactoring-ssdt-dropping-objects/#dropping-a-table&#34;&gt;deferred name resolution works for table names but not for column names&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;This is because of a detail of how foreign keys - and primary keys, for that matter - are maintained by SQL Server itself. If we look at the contents of &lt;code&gt;sys.foreign_key_columns&lt;/code&gt;, there isn&amp;rsquo;t a column name in sight (&lt;code&gt;sys.index_columns&lt;/code&gt; looks much the same):&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;constraint_ object_id&lt;/th&gt;
&lt;th&gt;constraint_ column_id&lt;/th&gt;
&lt;th&gt;parent_ object_id&lt;/th&gt;
&lt;th&gt;parent_ column_id&lt;/th&gt;
&lt;th&gt;referenced_ object_id&lt;/th&gt;
&lt;th&gt;referenced_ column_id&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;1045578763&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;885578193&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;565577053&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;917578307&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;565577053&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;597577167&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;965578478&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;725577623&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;629577281&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;933578364&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;629577281&lt;/td&gt;
&lt;td&gt;13&lt;/td&gt;
&lt;td&gt;661577395&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;&amp;hellip;&lt;/td&gt;
&lt;td&gt;&amp;hellip;&lt;/td&gt;
&lt;td&gt;&amp;hellip;&lt;/td&gt;
&lt;td&gt;&amp;hellip;&lt;/td&gt;
&lt;td&gt;&amp;hellip;&lt;/td&gt;
&lt;td&gt;&amp;hellip;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;If we fix the reference in our stored procedure and go on to generate a publish script, all we see for this change is&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;n&#34;&gt;PRINT&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;N&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;The following operation was generated from a refactoring log file 8a905288-76de-4cc4-aad9-c6dddf081a17&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;

&lt;span class=&#34;n&#34;&gt;PRINT&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;N&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Rename [dbo].[Track].[TrackId] to Track_Id&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;


&lt;span class=&#34;k&#34;&gt;GO&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;EXECUTE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;sp_rename&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;@&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;objname&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;N&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;[dbo].[Track].[TrackId]&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;@&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;newname&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;N&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Track_Id&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;@&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;objtype&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;N&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;COLUMN&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;


&lt;span class=&#34;k&#34;&gt;GO&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;PRINT&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;N&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Altering [dbo].[ChangeTrackPriceByFactor]...&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;


&lt;span class=&#34;k&#34;&gt;GO&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;ALTER&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;PROCEDURE&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dbo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;].[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ChangeTrackPriceByFactor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;
	&lt;span class=&#34;o&#34;&gt;@&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TrackID&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
	&lt;span class=&#34;o&#34;&gt;@&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Factor&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;NUMERIC&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;UPDATE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Track&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;SET&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;UnitPrice&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;@&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Factor&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Track_Id&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;@&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TrackID&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;RETURN&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;GO&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;-- Refactoring step to update target server with deployed transaction logs
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;IF&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;EXISTS&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;OperationKey&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dbo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;].[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__RefactorLog&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;OperationKey&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;8a905288-76de-4cc4-aad9-c6dddf081a17&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dbo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;].[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__RefactorLog&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;OperationKey&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;values&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;8a905288-76de-4cc4-aad9-c6dddf081a17&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;GO&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The &lt;code&gt;refactorlog&lt;/code&gt; is updated to include this change, but there are no changes deployed to any of the tables that referenced the &lt;code&gt;TrackId&lt;/code&gt; column via foreign keys. This is because foreign keys - as noted above - don&amp;rsquo;t &lt;em&gt;really&lt;/em&gt; use column names, they use object and column ids, so it is sufficient to rename the referenced column with &lt;code&gt;sp_rename&lt;/code&gt;. Stored Procedures, triggers, and other programmable objects, however, &lt;em&gt;do&lt;/em&gt; reference columns and tables by name - in &lt;code&gt;sys.sql_modules&lt;/code&gt; - so these references aren&amp;rsquo;t updated automatically.&lt;/p&gt;

&lt;p&gt;However, SSDT itself takes into consideration that when we rename a column referenced by a foreign (or primary) key, the definition required to create the constraint from scratch will need to be updated, which is why the files containing the referencing tables are all updated.&lt;/p&gt;

&lt;p&gt;This behaviour may seem inconsistent, but it is in fact consistent with the &lt;a href=&#34;https://msdn.microsoft.com/en-gb/library/ms188351.aspx#Anchor_3&#34; title=&#34;MSDN documentation for sp_rename&#34;&gt;behaviour of &lt;code&gt;sp_rename&lt;/code&gt; itself&lt;/a&gt;, which is to say that constraints and indexes aren&amp;rsquo;t broken by &lt;code&gt;sp_rename&lt;/code&gt;, but stored procedures, triggers, etc. are.&lt;/p&gt;

&lt;h3 id=&#34;the-wrong-way&#34;&gt;The wrong way&lt;/h3&gt;

&lt;p&gt;In contrast, renaming a column by editing the Transact-SQL file directly delivers the promised disaster, as SSDT will attempt to drop the column with the old name and create a new column with the new name.&lt;/p&gt;

&lt;p&gt;In the best-case scenario we get a validation error that stops the project from building, assuming the renamed column is referenced by some other object in the project.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://aksidjenakfjg.s3.amazonaws.com/ssdt-refactoring-part-2/renaming%20a%20key%20column%20in%20the%20sql%20file.PNG&#34; alt=&#34;Renaming a column by editing the .sql file&#34; title=&#34;Renaming a column by editing the .sql file]&#34; /&gt;&lt;/p&gt;

&lt;p&gt;In all other scenarios, the script executed at deploy time is as follows:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;n&#34;&gt;PRINT&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;N&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Altering [dbo].[Genre]...&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;GO&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;ALTER&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dbo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;].[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Genre&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;DROP&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;COLUMN&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;GO&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;ALTER&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dbo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;].[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Genre&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;ADD&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GenreName&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;NVARCHAR&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;120&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The only safety net left at this point is the &lt;a href=&#34;http://arapaima.uk/post/2016-10-25-database-refactoring-ssdt-dropping-objects/#pulling-the-trigger-3&#34;&gt;BlockOnPossibleDataLoss&lt;/a&gt; deploy-time option, which is enabled by default. This will stop the deployment from proceeding.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Msg 50000, Level 16, State 127, Line 48
Rows were detected. The schema update is terminating because data loss might occur.
** An error was encountered during execution of batch. Exiting.
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;renaming-tables&#34;&gt;Renaming tables&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;Refactoring Databases, p 113&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;There are two options in the refactoring context menu that are relevant to naming tables; &amp;ldquo;Rename&amp;rdquo; and &amp;ldquo;Move to Schema&amp;rdquo;. In some RDBMSs, notably &lt;a href=&#34;https://docs.oracle.com/database/122/CNCPT/tables-and-table-clusters.htm#GUID-72E247B5-F39A-47F1-9445-72D9221F57E3&#34; title=&#34;Introduction to schema objects, Oracle 12.2&#34;&gt;Oracle&lt;/a&gt;, the notion of a schema is tightly coupled to the notion of a user, such that the user account in question &amp;ldquo;owns&amp;rdquo; the tables and other objects contained therein. SQL Server implemented a similar concept prior to SQL Server 2005, when the &lt;a href=&#34;https://technet.microsoft.com/en-us/library/dd283095.aspx&#34; title=&#34;SQL Server Best Practices – Implementation of Database Object Schemas&#34;&gt;link between users and schemas was severed&lt;/a&gt; such that a schema became more like a namespace, or even a filesystem folder, since a schema remains a securable object. Under either analogy - namespace or folder - the name of the schema can be considered to be a part of the (qualified) name of the table, meaning that moving an object to a new schema is merely a special case of renaming.&lt;/p&gt;

&lt;h3 id=&#34;the-right-way&#34;&gt;The right way&lt;/h3&gt;

&lt;p&gt;&lt;img src=&#34;http://aksidjenakfjg.s3.amazonaws.com/ssdt-refactoring-part-2/refactoring-menu.PNG&#34; alt=&#34;Right-click refactor menu for a table&#34; title=&#34;Right-click Refactor menu for a table&#34; /&gt;&lt;/p&gt;

&lt;p&gt;When we rename a table, we get the usual &amp;ldquo;refactor preview&amp;rdquo; showing the changes about to be applied to the project:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://aksidjenakfjg.s3.amazonaws.com/ssdt-refactoring-part-2/Refactor%20renaming%20a%20table.PNG&#34; alt=&#34;Refactor preview for renaming a table&#34; title=&#34;Refactor preview for renaming a table&#34; /&gt;&lt;/p&gt;

&lt;p&gt;On clicking apply, the relevant objects are updated and a new entry is inserted into the &lt;code&gt;refactorlog&lt;/code&gt; file:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-xml&#34; data-lang=&#34;xml&#34;&gt;&lt;span class=&#34;nt&#34;&gt;&amp;lt;Operation&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;Rename Refactor&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Key=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;cce28c30-adb0-4019-876e-d93cc2ca0011&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;ChangeDateTime=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;11/12/2016 14:22:18&amp;#34;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;&amp;gt;&lt;/span&gt;
   &lt;span class=&#34;nt&#34;&gt;&amp;lt;Property&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;ElementName&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Value=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;[dbo].[Artist]&amp;#34;&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;/&amp;gt;&lt;/span&gt;
   &lt;span class=&#34;nt&#34;&gt;&amp;lt;Property&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;ElementType&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Value=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;SqlTable&amp;#34;&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;/&amp;gt;&lt;/span&gt;
   &lt;span class=&#34;nt&#34;&gt;&amp;lt;Property&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;ParentElementName&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Value=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;[dbo]&amp;#34;&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;/&amp;gt;&lt;/span&gt;
   &lt;span class=&#34;nt&#34;&gt;&amp;lt;Property&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;ParentElementType&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Value=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;SqlSchema&amp;#34;&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;/&amp;gt;&lt;/span&gt;
   &lt;span class=&#34;nt&#34;&gt;&amp;lt;Property&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;NewName&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Value=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;[Artiste]&amp;#34;&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;/&amp;gt;&lt;/span&gt;
 &lt;span class=&#34;nt&#34;&gt;&amp;lt;/Operation&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The process for moving a table between schemas is similar, we are presented with a preview of the changes about to be made:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://aksidjenakfjg.s3.amazonaws.com/ssdt-refactoring-part-2/move%20to%20schema%20preview.PNG&#34; alt=&#34;Refactor preview for move to schema&#34; title=&#34;Refactor preview for move to schema&#34; /&gt;&lt;/p&gt;

&lt;p&gt;and a new entry is made in the &lt;code&gt;refactorlog&lt;/code&gt; file.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-xml&#34; data-lang=&#34;xml&#34;&gt;&lt;span class=&#34;nt&#34;&gt;&amp;lt;Operation&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;Move Schema&amp;#34;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;Key=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;985e03c6-37f8-48c8-8ce8-5ed37fbb7c00&amp;#34;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;ChangeDateTime=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;11/12/2016 14:46:31&amp;#34;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;&amp;gt;&lt;/span&gt;
  &lt;span class=&#34;nt&#34;&gt;&amp;lt;Property&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;ElementName&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Value=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;[dbo].[Invoice]&amp;#34;&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;/&amp;gt;&lt;/span&gt;
  &lt;span class=&#34;nt&#34;&gt;&amp;lt;Property&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;ElementType&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Value=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;SqlTable&amp;#34;&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;/&amp;gt;&lt;/span&gt;
  &lt;span class=&#34;nt&#34;&gt;&amp;lt;Property&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;NewSchema&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Value=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;Sales&amp;#34;&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;/&amp;gt;&lt;/span&gt;
  &lt;span class=&#34;nt&#34;&gt;&amp;lt;Property&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;IsNewSchemaExternal&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Value=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;False&amp;#34;&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;/&amp;gt;&lt;/span&gt;
&lt;span class=&#34;nt&#34;&gt;&amp;lt;/Operation&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Finally, when we come to deploy our change, the table is moved to the new schema and all the referencing objects are updated:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;PRINT N&#39;The following operation was generated from a refactoring log file 985e03c6-37f8-48c8-8ce8-5ed37fbb7c00&#39;;

PRINT N&#39;Move object [dbo].[Invoice] to different schema [Sales]&#39;;

GO
ALTER SCHEMA [Sales] TRANSFER [dbo].[Invoice];

GO
ALTER VIEW [dbo].[InvoicesWithLineTotals] 
	AS SELECT I.[Invoice_Id],
	InvoiceTotal
	FROM [Sales].Invoice AS I CROSS APPLY dbo.CalculateInvoiceTotal(I.[Invoice_Id]);
GO
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;the-wrong-way-1&#34;&gt;The wrong way&lt;/h3&gt;

&lt;p&gt;As with columns, if we rename a table by editing the &lt;code&gt;.sql&lt;/code&gt; file directly, we get a potentially undesirable outcome, namely that a new table will created with the new name, possibly at the expense of the current table. If we are lucky we get a validation error that stops the project from building:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://aksidjenakfjg.s3.amazonaws.com/ssdt-refactoring-part-2/rename%20validation%20error.PNG&#34; alt=&#34;Error from renaming a table in the sql file&#34; title=&#34;error from renaming a table in the .sql file&#34; /&gt;&lt;/p&gt;

&lt;p&gt;If we are less lucky we may get some warnings (remember that deferred name resolution means that a missing table is only a warning rather than an error in a stored procedure), but at deploy time we will get a new table created with the new name, and possibly even a &lt;code&gt;DROP TABLE&lt;/code&gt; for the existing table, assuming we have the appropriate options set. (By default, SSDT won&amp;rsquo;t drop objects from the database unless we specify &amp;ldquo;&lt;a href=&#34;http://arapaima.uk/post/2016-10-25-database-refactoring-ssdt-dropping-objects/#a-note-on-drop-objects-not-in-source&#34;&gt;Drop objects in target but not in source&lt;/a&gt;&amp;rdquo;).&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;n&#34;&gt;PRINT&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;N&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Dropping [dbo].[PlaylistTrack]...&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;GO&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;DROP&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dbo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;].[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PlaylistTrack&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;GO&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;PRINT&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;N&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Creating [dbo].[Playlist_Track]...&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;GO&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dbo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;].[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Playlist_Track&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PlaylistId&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;INT&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TrackId&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;    &lt;span class=&#34;nb&#34;&gt;INT&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;CONSTRAINT&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PK_PlaylistTrack&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;PRIMARY&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;KEY&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;NONCLUSTERED&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;([&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PlaylistId&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;ASC&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TrackId&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;ASC&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&#34;renaming-programmable-objects-views-functions-stored-procedures-other-miscellany-in-sys-sql-modules&#34;&gt;Renaming Programmable Objects (Views, Functions, Stored Procedures, other miscellany in [&lt;code&gt;sys.sql_modules&lt;/code&gt;]&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;Refactoring Databases, p 117&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;As noted in the &lt;a href=&#34;http://arapaima.uk/post/2016-10-25-database-refactoring-ssdt-dropping-objects/#dropping-programmable-objects-views-functions-stored-procedures-other-miscellany-in-sys-sql-modules-https-msdn-microsoft-com-en-us-library-ms175081-aspx&#34;&gt;discussion of dropping programmable objects&lt;/a&gt;, operations involving these objects involve substantially less risk of catastrophic data loss and consequent unemployment than similar operation involving tables and columns.&lt;/p&gt;

&lt;p&gt;It is still important to use the Refactor &amp;rarr; Rename and Refactor &amp;rarr; Move to Schema techniques to rename these objects rather than directly editing the &lt;code&gt;.sql&lt;/code&gt; files, so that an entry is written to the &lt;code&gt;.refactorlog&lt;/code&gt; file. This will ensure that the existing object is altered rather than a new one created at the expense of the old one.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-xml&#34; data-lang=&#34;xml&#34;&gt;&lt;span class=&#34;nt&#34;&gt;&amp;lt;Operation&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;Rename Refactor&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Key=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;fc4b928d-9b00-4028-9cac-5859ba9b666c&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;ChangeDateTime=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;11/12/2016 22:50:20&amp;#34;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;&amp;gt;&lt;/span&gt;
  &lt;span class=&#34;nt&#34;&gt;&amp;lt;Property&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;ElementName&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Value=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;[dbo].[ChangeTrackPriceByFactor]&amp;#34;&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;/&amp;gt;&lt;/span&gt;
  &lt;span class=&#34;nt&#34;&gt;&amp;lt;Property&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;ElementType&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Value=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;SqlProcedure&amp;#34;&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;/&amp;gt;&lt;/span&gt;
  &lt;span class=&#34;nt&#34;&gt;&amp;lt;Property&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;ParentElementName&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Value=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;[dbo]&amp;#34;&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;/&amp;gt;&lt;/span&gt;
  &lt;span class=&#34;nt&#34;&gt;&amp;lt;Property&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;ParentElementType&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Value=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;SqlSchema&amp;#34;&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;/&amp;gt;&lt;/span&gt;
  &lt;span class=&#34;nt&#34;&gt;&amp;lt;Property&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Name=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;NewName&amp;#34;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;Value=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;[ChangeTrackPriceByMultiplier]&amp;#34;&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;/&amp;gt;&lt;/span&gt;
&lt;span class=&#34;nt&#34;&gt;&amp;lt;/Operation&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;footnotes&#34;&gt;

&lt;hr /&gt;

&lt;ol&gt;
&lt;li id=&#34;fn:1&#34;&gt;It isn&amp;rsquo;t magic, this doesn&amp;rsquo;t work with dynamic SQL, for instance.
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:1&#34;&gt;&lt;sup&gt;[return]&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
</description>
        </item>
      
    
      
        <item>
          <title>Database Pruning</title>
          <link>http://arapaima.uk/post/2016-10-25-database-refactoring-ssdt-dropping-objects/</link>
          <pubDate>Tue, 25 Oct 2016 00:00:00 UTC</pubDate>
          <author>Gavin Campbell</author>
          <guid>http://arapaima.uk/post/2016-10-25-database-refactoring-ssdt-dropping-objects/</guid>
          <description>

&lt;p&gt;After a period of time in use, most databases, like many systems that have grown in an organic matter, can benefit from some judicious pruning. This can take the form of removing columns or even tables no longer required to support the application, or that store redundant - and hence possibly erroneous - copies of information stored elsewhere. Equally there may be stored procedures, functions, and even triggers that contain out-of-date versions of application logic.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://upload.wikimedia.org/wikipedia/commons/7/70/The_gardener%27s_assistant%3B_a_practical_and_scientific_exposition_of_the_art_of_gardening_in_all_its_branches_%281910%29_%2814761716416%29.jpg&#34; alt=&#34;The gardener&#39;s assistant; a practical and scientific exposition of the art of gardening in all its branches (1910) (14761716416).jpg&#34; title=&#34;[By Internet Archive Book Images [No restrictions], via Wikimedia Commons]&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;dropping-a-column&#34;&gt;Dropping a column&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;Refactoring Databases, p 72&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Since SSDT operates in a declarative manner, each table is defined in a &lt;code&gt;CREATE TABLE&lt;/code&gt; script, and deleting a column is as simple as deleting the relevant line from the script. However, there are a couple of features of SSDT that are relevant here. If the column is referenced by any other database objects such as views, functions, or stored procedures, SSDT will display an error:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://s3-eu-west-1.amazonaws.com/aksidjenakfjg/ssdt-refactoring-part-1/DropColumnReferencedByProcedure.PNG&#34; alt=&#34;SSDT Broken Reference Error&#34; title=&#34;SSDT Broken Reference Error&#34; /&gt;&lt;/p&gt;

&lt;p&gt;The full text of the error message reads &lt;code&gt;SQL71501: Procedure [dbo.UpdateInvoiceBillingAddress] has an unresolved reference to object [dbo].[Invoice].[BillingPostalCode]&lt;/code&gt;, and the offending reference in the stored procedure&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:1&#34;&gt;&lt;a rel=&#34;footnote&#34; href=&#34;#fn:1&#34;&gt;1&lt;/a&gt;&lt;/sup&gt; has acquired a &amp;ldquo;red squiggly&amp;rdquo;. There&amp;rsquo;s no &amp;ldquo;builtin&amp;rdquo; refactoring action defined in the right-click context menu for deletions, presumably as it&amp;rsquo;s difficult to programmatically determine the &amp;ldquo;intent&amp;rdquo; of a deleting a column.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://s3-eu-west-1.amazonaws.com/aksidjenakfjg/ssdt-refactoring-part-1/Refactoring+Menu.PNG&#34; alt=&#34;Refactoring Context Menu&#34; title=&#34;Refactoring Context Menu&#34; /&gt;&lt;/p&gt;

&lt;p&gt;What is possible, however, is to use the &amp;ldquo;find all references&amp;rdquo; tool &lt;em&gt;before&lt;/em&gt; deleting the column to enable us to take appropriate action.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://s3-eu-west-1.amazonaws.com/aksidjenakfjg/ssdt-refactoring-part-1/findAllReferences.PNG&#34; alt=&#34;Find All References&#34; title=&#34;Find All References&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;dropping-a-table&#34;&gt;Dropping a table&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;Refactoring Databases, p 77&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This is where things get more serious. The same technique of using the &amp;ldquo;Find All References&amp;rdquo; tool to assess the damage we&amp;rsquo;re about to do applies here, but there is a subtle difference in what happens when we actually brandish the pruning shears. It turns out that removing an entire table referenced by a stored procedure is only worthy of a warning or five rather than an error. This is due to an oddity of &lt;a href=&#34;https://technet.microsoft.com/en-us/library/ms190686.aspx&#34;&gt;deferred name resolution&lt;/a&gt; for stored procedures, namely that it is permitted to reference a non-existent table in the text of a stored procedure, but not permitted to reference a non-existent column in a table that &lt;em&gt;does&lt;/em&gt; exist.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://s3-eu-west-1.amazonaws.com/aksidjenakfjg/ssdt-refactoring-part-1/RemovingATableIsOnlyAWarning.PNG&#34; alt=&#34;Removing a table is only a warning&#34; title=&#34;Removing a table is only a warning&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Interestingly, if we convert our stored procedure to a user-defined function &lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:2&#34;&gt;&lt;a rel=&#34;footnote&#34; href=&#34;#fn:2&#34;&gt;2&lt;/a&gt;&lt;/sup&gt; the warnings turn into errors. It turns out deferred name resolution doesn&amp;rsquo;t work at all for functions, presumably as being &amp;ldquo;purely functional&amp;rdquo; and not side-effecting it is less likely that there will be objects that exist at runtime but not at creation time.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://s3-eu-west-1.amazonaws.com/aksidjenakfjg/ssdt-refactoring-part-1/FunctionsDontSupportDeferredNameResolution.PNG&#34; alt=&#34;Functions don&#39;t support deferred name resolution&#34; title=&#34;Functions don&#39;t support deferred name resolution&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;dropping-programmable-objects-views-functions-stored-procedures-other-miscellany-in-sys-sql-modules-https-msdn-microsoft-com-en-us-library-ms175081-aspx&#34;&gt;Dropping Programmable Objects (Views, Functions, Stored Procedures, other miscellany in &lt;a href=&#34;https://msdn.microsoft.com/en-us/library/ms175081.aspx&#34;&gt;&lt;code&gt;sys.sql_modules&lt;/code&gt;&lt;/a&gt;)&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;Refactoring Databases, p 79&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;On the face of it this is simpler, as there is no data being thrown out with the bathwater.&lt;/p&gt;

&lt;h3 id=&#34;dropping-triggers&#34;&gt;Dropping Triggers&lt;/h3&gt;

&lt;p&gt;You should do this without hesitation. It&amp;rsquo;s 2016.&lt;/p&gt;

&lt;h3 id=&#34;dropping-views-and-functions&#34;&gt;Dropping views and functions&lt;/h3&gt;

&lt;p&gt;Generally, this is unproblematic. Since these don&amp;rsquo;t support deferred name resolution, you can get error checking in SSDT.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://s3-eu-west-1.amazonaws.com/aksidjenakfjg/ssdt-refactoring-part-1/NameCheckingInViews.PNG&#34; alt=&#34;Name checking in views&#34; title=&#34;Name checking in views&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;pulling-the-trigger-3&#34;&gt;Pulling the trigger&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:3&#34;&gt;&lt;a rel=&#34;footnote&#34; href=&#34;#fn:3&#34;&gt;3&lt;/a&gt;&lt;/sup&gt;&lt;/h2&gt;

&lt;p&gt;There&amp;rsquo;s one more thing to consider, which is what happens when we come to deploy our changes. Whether we do this by publishing from Visual Studio or at the command line using &lt;code&gt;sqlpackage.exe&lt;/code&gt;, if we are dropping a table or a column that contains data we will get an error along the lines of&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;(48,1): SQL72014: .Net SqlClient Data Provider: Msg 50000, Level 16, State 127, Line 6 Rows were detected. The schema update is terminating because data loss might occur.
(43,0): SQL72045: Script execution error.  The executed script:
IF EXISTS (SELECT TOP 1 1
           FROM   [dbo].[PlaylistTrack])
    RAISERROR (N&#39;Rows were detected. The schema update is terminating because data loss might occur.&#39;, 16, 127)
        WITH NOWAIT;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &lt;code&gt;IF EXISTS&lt;/code&gt; check gets inserted into the deployment script for every table, and every table containing a column, that is being dropped. It is worth noting that since the check is for &lt;code&gt;EXISTS (SELECT TOP 1 1)&lt;/code&gt;, this check will fail and the deployment will be blocked even if we are dropping a column that only contains &lt;code&gt;NULL&lt;/code&gt; values - I have found this to be mildly irritating in the past, particularly for &amp;ldquo;inadvertently&amp;rdquo; created columns.&lt;/p&gt;

&lt;p&gt;To inhibit this behaviour and allow our potentially destructive change to proceed, we need to specify this at deploy time, the mechanism for which depends on the method we are using to deploy our project.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;For projects deployed using the Visual Studio &amp;ldquo;Publish&amp;rdquo; dialog, uncheck &amp;ldquo;Block Incremental Deployment if Data Loss might Occur&amp;rdquo; in the &amp;ldquo;Advanced Publish Settings&amp;rdquo; dialog available by clicking &amp;ldquo;Advanced&amp;rdquo; in the &amp;ldquo;Publish&amp;rdquo; dialog.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;For projects deployed using &lt;code&gt;sqlpackage.exe&lt;/code&gt;, we need to specify the parameter &lt;code&gt;/p:BlockOnPossibleDataLoss=False&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;For projects that use a publish profile to specify deployment options, we need to add the element &lt;code&gt;&amp;lt;BlockOnPossibleDataLoss&amp;gt;False&amp;lt;/BlockOnPossibleDataLoss&amp;gt;&lt;/code&gt; to the &lt;code&gt;.publish.xml&lt;/code&gt; file.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;In each case, the default is &amp;ldquo;true&amp;rdquo;, meaning potentially destructive changes are blocked by default. This is for the benefit of those &amp;ldquo;enterprise&amp;rdquo; customers that deploy direct to production with no testing - remember that these people aren&amp;rsquo;t our problem but they are the SSDT development team&amp;rsquo;s problem, since they are paying to keep the lights on at SSDT HQ!&lt;/p&gt;

&lt;p&gt;In general, this should always be set to false, meaning &amp;ldquo;allow potentially destructive changes&amp;rdquo;. This is unproblematic as long as production isn&amp;rsquo;t the &lt;em&gt;first&lt;/em&gt; environment where you deploy your changes.&lt;/p&gt;

&lt;p&gt;Similarly, the default behaviour of SSDT is &lt;em&gt;not&lt;/em&gt; to drop objects that are in the target (i.e. the database) but not in the source (i.e. the database project). To allow these changes to be applied, we need to do one of the following.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;For projects deployed using the Visual Studio &amp;ldquo;Publish&amp;rdquo; dialog, check &amp;ldquo;Drop objects in target but not in source&amp;rdquo; in the &amp;ldquo;Advanced Publish Settings&amp;rdquo; dialog available by clicking &amp;ldquo;Advanced&amp;rdquo; in the &amp;ldquo;Publish&amp;rdquo; dialog.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;For projects deployed using &lt;code&gt;sqlpackage.exe&lt;/code&gt;, we need to specify the parameter &lt;code&gt;/p:DropObjectsNotInSource=True&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;For projects that use a publish profile to specify deployment options, we need to add the element &lt;code&gt;&amp;lt;DropObjectsNotInSource&amp;gt;True&amp;lt;/DropObjectsNotInSource&amp;gt;&lt;/code&gt; to the &lt;code&gt;.publish.xml&lt;/code&gt; file.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;a-note-on-drop-objects-not-in-source&#34;&gt;A note on &amp;ldquo;Drop objects not in source&amp;rdquo;&lt;/h3&gt;

&lt;p&gt;If this option is selected, SSDT will drop &lt;em&gt;all&lt;/em&gt; objects from the target database that are not defined in the project. Rather inconveniently, this includes users, permissions - including, cruciallly, the &lt;code&gt;CONNECT&lt;/code&gt; permission - and all the other things we need to be present for our application (or us!) to be able to connect to the database. Rather than specify all these items as part of the project, it is often simpler to ignore these at deployment time using the publish profile. The most important ones are probably users, permissions, roles, and role memberships, but anyone with a more obscure security model (Application Roles??) might want to investigate some of the other options.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://aksidjenakfjg.s3.amazonaws.com/ssdt-refactoring-part-1/Options-for-drop-objects.PNG&#34; alt=&#34;Advanced Publish Settings showing drop objects&#34; title=&#34;Advanced Publish Settings showing drop objects&#34; /&gt;&lt;/p&gt;

&lt;p&gt;The difference between the &amp;ldquo;Drop&amp;rdquo; and &amp;ldquo;Ignore&amp;rdquo; settings is that the former apply &lt;em&gt;only&lt;/em&gt; to the target - so selecting object types here prevents objects of that type from being dropped. The &amp;ldquo;ignore&amp;rdquo; settings allow us to specify that objects of the selected types are not dropped in the target if they are absent from the source, but also not created or modified in the target even if they are present in the source.&lt;/p&gt;

&lt;p&gt;As above, these settings can also be specified as command-line arguments to &lt;code&gt;sqlpackage.exe&lt;/code&gt; or as xml in a publish profile.&lt;/p&gt;
&lt;div class=&#34;footnotes&#34;&gt;

&lt;hr /&gt;

&lt;ol&gt;
&lt;li id=&#34;fn:1&#34;&gt;This procedure isn&amp;rsquo;t in the original Chinook database, I added it for the purpose of this example.
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:1&#34;&gt;&lt;sup&gt;[return]&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li id=&#34;fn:2&#34;&gt;which it should have been in the first place, as it doesn&amp;rsquo;t modify any data!
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:2&#34;&gt;&lt;sup&gt;[return]&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li id=&#34;fn:3&#34;&gt;No, not that kind of trigger, this refers to the metaphorical kind.
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:3&#34;&gt;&lt;sup&gt;[return]&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
</description>
        </item>
      
    
      
        <item>
          <title>Refactoring Databases with SSDT</title>
          <link>http://arapaima.uk/post/2016-10-21-database-refactoring-part-0/</link>
          <pubDate>Fri, 21 Oct 2016 00:00:00 UTC</pubDate>
          <author>Gavin Campbell</author>
          <guid>http://arapaima.uk/post/2016-10-21-database-refactoring-part-0/</guid>
          <description>&lt;p&gt;The book &lt;a href=&#34;http://www.pearsoned.co.uk/bookshop/detail.asp?WT.oss=refactoring%20databases&amp;amp;WT.oss_r=1&amp;amp;item=100000000444392&#34;&gt;Refactoring Databases&lt;/a&gt; by Scott Ambler and Pramod Sadalage, first published over ten years ago, has become something of a modern classic in the field of agile database delivery. The authors give a definition (in fact taken from an &lt;a href=&#34;http://eu.wiley.com/WileyCDA/WileyTitle/productCd-0471202835.html&#34;&gt;earlier book&lt;/a&gt;) of a database refactoring as&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&amp;hellip;a simple change to a database schema that improves its design while retaining both its behavioral and informational semantics.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;The book is divided into two sections, the first being a discussion of agile database development techniques, placing database refactoring in a wider technical and organisational contect. This material, intended to be read in order, is recommended reading for anyone struggling to improve the working practices associated with database delivery in any organisation, irrespective of the tools being used.&lt;/p&gt;

&lt;p&gt;The second is a collection of named &amp;ldquo;refactorings&amp;rdquo; along with the steps required to implement each one, and is structured as a reference work rather than as a continuous narrative. There are online versions of this catalog maintained at the websites of &lt;a href=&#34;http://www.agiledata.org/essays/databaseRefactoringCatalog.html&#34;&gt;Scott Ambler&lt;/a&gt; and &lt;a href=&#34;http://databaserefactoring.com/&#34;&gt;Pramod Sadalage&lt;/a&gt; respectively.&lt;/p&gt;

&lt;p&gt;This article marks the start of a series that examines a number of these named &amp;ldquo;refactorings&amp;rdquo; and looks at how they can be implemented using Microsoft® SQL Server and Microsoft® Visual Studio, in particular through the use of &lt;a href=&#34;https://blogs.msdn.microsoft.com/ssdt/&#34;&gt;SQL Server Data Tools&lt;/a&gt;, known as &amp;ldquo;SSDT&amp;rdquo;.&lt;/p&gt;

&lt;p&gt;The code examples in the book use Oracle with bits of Java and Hibernate thrown in as appropriate, so the procedures here will differ where the behaviour of SQL Server differs in some relevant way. In addition, the &amp;ldquo;&lt;a href=&#34;https://blogs.msdn.microsoft.com/gertd/2009/06/05/declarative-database-development&#34; title=&#34;The original DataDude article from way back&#34;&gt;declarative&lt;/a&gt;&amp;rdquo; development paradigm encouraged by SSDT hides a lot of the detail of the DDL behind the scenes, meaning that the steps outlined in the book to achieve each refactoring may not all occur in the same places.&lt;/p&gt;

&lt;p&gt;That said, it is worth referring to the discussions of each individual refactoring contained in the book, since these provide a checklist of considerations before embarking on any change, including motivations, tradeoffs, schema update and data migration mechanics, and required application changes, most of which are outside the scope of SSDT. I will attempt to provide page numbers where appropriate, though I realise these are less useful for those with access to only an electronic copy of the book.&lt;/p&gt;

&lt;p&gt;In general, the applicability of SSDT is restricted to managing schema changes, with a couple of extensibility points - namely &lt;a href=&#34;https://msdn.microsoft.com/en-us/library/jj889461(v=vs.103).aspx&#34;&gt;Pre-deployment and Post-deployment scripts&lt;/a&gt; -  to manage data movements.&lt;/p&gt;

&lt;p&gt;This series does presuppose some experience with SSDT; an overview can be obtained from MSDN &lt;a href=&#34;https://msdn.microsoft.com/en-us/library/hh272686(v=vs.103).aspx&#34;&gt;here&lt;/a&gt;, particularly the material relating to &lt;a href=&#34;https://msdn.microsoft.com/en-us/library/hh272702(v=vs.103).aspx&#34;&gt;Project-Oriented Offline Database Development&lt;/a&gt;. In the event that I ever get around to writing any introductory material of my own I&amp;rsquo;ll come back and add links here as appropriate. Most of the examples use the &amp;ldquo;Chinook&amp;rdquo; sample database available from &lt;a href=&#34;https://chinookdatabase.codeplex.com/&#34;&gt;codeplex&lt;/a&gt;. The SSDT project I am using is on &lt;a href=&#34;https://github.com/arapaima-uk/Refactoring.Chinook&#34; title=&#34;Link to the Refactoring.Chinook repo&#34;&gt;Github&lt;/a&gt;, but note that I&amp;rsquo;ve made no attempt to make the commits sync with the articles in the series, and there are no guarantees, express or implied, that any given commit will actually be buildable.&lt;/p&gt;
</description>
        </item>
      
    

  </channel>
</rss>
